<?xml version="1.0"?>

<flight_control name="F-16 FC">

<!--
    begin: control system by Nikolai V. Chr.

    AD-A055-417 - Main source.
    AD-A189-675 - I wish, too blurred to read.
    TP-1538 - used for control system B/C and non-prototype gains.
    TN-D-8176 - used for servodynamic filters. Disabled for now (fdm rate is only 120Hz).
    ICAS-90-5.10.2 - used for MPO switch
    AFSC 32657C - has more clean view of Integrator pitch loop.
 -->

    <channel execrate="1" name="FCS Lookup">

        <switch name="fcs/fly-by-wire/MLG-GND">
            <description>
                Main landing gear on ground
            </description>
            <default value="0"/>
            <test logic="AND" value="1">
                gear/unit[1]/WOW eq 1
                gear/unit[2]/WOW eq 1
            </test>
        </switch>
		
		<switch name="fcs/fly-by-wire/Note-5">
			<description>
                LJQC: Note 5 in 189675
            </description>
            <default value="0"/>
            <test logic="OR" value="1">
                gear/gear-cmd-norm == 1
                /controls/flight/flaps gt 0
            </test>
        </switch>

        <switch name="fcs/fly-by-wire/condition-a">
			<description>
                LJQC: According to Note 1 in 189675, condition on q_c is 600.
            </description>
            <default value="0"/>
            <test logic="AND" value="1">
                fcs/fly-by-wire/Note-5 == 1
                fcs/fly-by-wire/q_c lt 600
            </test>
            <test logic="AND" value="1">
                /systems/refuel/serviceable == 1
                fcs/fly-by-wire/q_c lt 600
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/condition-b">
            <description>
                Since this was removed on later blocks,
                not sure when, it is used just for
                prototype for now.
            </description>
            <default value="0"/>
            <test logic="AND" value="1">
                fcs/fly-by-wire/MLG-GND == 1
                gear/unit[0]/WOW == 1
                fcs/speedbrake-pos-deg == 60
                fcs/throttle-cmd-deg lt 17
                fcs/throttle-cmd-deg ge 16
                fcs/fly-by-wire/prototype == 1
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/condition-aar">
			<description>
                LJQC: According to 189675, condition on q_c is 600.
            </description>
            <default value="0"/>
            <test logic="AND" value="1">
                /systems/refuel/serviceable == 1
                fcs/fly-by-wire/q_c lt 600
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/condition-z-raw">
            <default value="0"/>
            <test logic="OR" value="1">
                fcs/fly-by-wire/condition-a == 1
            </test>
        </switch>
        
        <lag_filter name="fcs/fly-by-wire/condition-z">
            <input> fcs/fly-by-wire/condition-z-raw </input>
            <c1> 0.125 </c1>
        </lag_filter>
        
        <fcs_function name="fcs/fly-by-wire/condition-y">
            <function>
                <sum>
                    <product>
                        <v>-1</v>
                        <p>fcs/fly-by-wire/condition-z</p>
                    </product>
                    <v>1</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/q_c_standby">
            <description>
                pound per square feet
            </description>
            <default value="1400"/>
            <test logic="AND" value="200">
                fcs/fly-by-wire/condition-a == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/q_c">
            <description>
                Dynamic pressure. Pound per square feet
            </description>
            <function>
                <ifthen>
                    <p>fcs/fly-by-wire/enable-standby-gains</p>
                    <p>fcs/fly-by-wire/q_c_standby</p>
                    <p>aero/qbar-psf</p>
                </ifthen>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/q_c_Nsqm">
            <description>
                Newton per square meter
            </description>
            <function>
                <product>
                    <p>fcs/fly-by-wire/q_c</p>
                    <v>47.880258889</v>
                </product>
            </function>
        </fcs_function>
        
        <fcs_function name="fcs/fly-by-wire/P_s">
            <description>
                Static pressure. Pound per square feet
            </description>
            <function>
                <ifthen>
                    <p>fcs/fly-by-wire/enable-standby-gains</p>
                    <v>2116</v>
                    <p>atmosphere/P-psf</p>
                </ifthen>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/qcps-ratio">
            <function>
                <quotient>
                    <p>fcs/fly-by-wire/q_c</p>
                    <p>fcs/fly-by-wire/P_s</p>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/F1">
            <description>Stick limit</description>
            <function>
                <table>
                <independentVar lookup="row">fcs/fly-by-wire/q_c</independentVar>
                <tableData>
                    34     -1
                    184    -4
                </tableData>
            </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/F2">
            <description>Static stability
                         TP-1538: simplified to 0.5
            </description>
            <function>
                <table>
                <independentVar lookup="row">fcs/fly-by-wire/qcps-ratio</independentVar>
                <tableData>
                    0     0.50
                    0.53  0.50
                    1.79 -1.00
                </tableData>
            </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/F3">
            <description>Pitch rate gain and pitch loop gain schedule.</description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/q_c</independentVar>
                    <tableData>
                        0.0 1
                        300 1
                        800 0.533
                        3000 0.083
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/F3-loop-alt">
            <description>
                TP-1538: pitch loop gain schedule.

                Not used
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/q_c_Nsqm</independentVar>
                    <tableData>
                        0.0   1.0
                        13000 1.0
                        43000 0.4
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/F3-rate-alt">
            <description>
                TP-1538: Pitch rate gain schedule. 

                Not used
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/q_c_Nsqm</independentVar>
                    <tableData>
                        0.0   1.0
                        5500  1.0
                        15500 0.3
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/ari/F7">
            <description>Turn coordination
                         TP-1538 is almost same.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/qcps-ratio</independentVar>
                    <tableData>
                        0.0   0
                        0.187 0
                        1.129 1
                        1.709 1
                        3.29  0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/yaw/F8">
            <description>Yaw axis
                         TP-1538 is simplified to 0.5
						 LJQC: Compensate for decrease in directional stability at higher mach. Since aero coeff is only for 0.6 mach, so we only need 0.5.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/qcps-ratio</independentVar>
                    <tableData>
                        0.0  0.5
                        2.04 0.5
                        3.23 0.5
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/tef/F9">
            <description>Transonic flaps</description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/qcps-ratio</independentVar>
                    <tableData>
                        0.0  0
                        0.787 0
                        1.008 -2.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/F10">
            <description>Roll horiz tail
                         TP-1538 is simplified to 0.25
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/qcps-ratio</independentVar>
                    <tableData>
                        0.0   0.25
                        0.694 0.25
                        1.132 0.50
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="accelerations/a_n">
            <description>
                Page 43: Calc of G-force.

                I had some trouble using the Nz, but don't remember what it was.
            </description>
            <function>
                <quotient>
                    <sum>
                        <product>
                            <property> velocities/q-rad_sec </property>
                            <property> velocities/u-fps </property>
                        </product>
                        <product>
                            <v>-1</v>
                            <property> velocities/p-rad_sec </property>
                            <property> velocities/v-fps </property>
                        </product>
                        <product>
                            <v> 32.174 </v>
                            <cos>
                                <property> attitude/theta-rad </property>
                            </cos>
                            <cos>
                                <property> attitude/phi-rad </property>
                            </cos>
                        </product>
                        <product>
                            <v>-1</v>
                            <property> accelerations/wdot-ft_sec2 </property>
                        </product>
                    </sum>
                    <v> 32.174 </v>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="accelerations/a_y">
            <description>
                Page 43: Calc of lateral G-force.

                I had some trouble using the Ny. Its feedback made rudder oscillate at very high speeds.
            </description>
            <function>
                <quotient>
                    <sum>
                        <product>
                            <property> velocities/p-rad_sec </property>
                            <property> velocities/w-fps </property>
                            <v>-1</v>
                        </product>
                        <product>
                            <property> velocities/r-rad_sec </property>
                            <property> velocities/u-fps </property>
                        </product>
                        <product>
                            <v>-1</v>
                            <v> 32.174 </v>
                            <cos>
                                <property> attitude/theta-rad </property>
                            </cos>
                            <sin>
                                <property> attitude/phi-rad </property>
                            </sin>
                        </product>
                        <property> accelerations/vdot-ft_sec2 </property>
                    </sum>
                    <v> 32.174 </v>
                </quotient>
            </function>
        </fcs_function>

    </channel><!-- end of FBW lookup -->






























    <channel execrate="1" name="Pitch">

        <switch name="fcs/fly-by-wire/pitch/trim-cmd">
            <description>
                GR1F-16CJ-1 page 1-135
                With both main wheel speeds at 60 knots groundspeed
                or greater, pitch trim automatically centers.
                GR1F-16CJ-1 page 1-120
                DBU - Pitch trim centering at wheel spin-up is inoperative
            </description>
            <default value="/controls/flight/elevator-trim"/>
            <test logic="AND" value="0">
                fcs/fly-by-wire/MLG-GND == 1
                gear/unit[1]/wheel-speed-fps gt 100
                gear/unit[2]/wheel-speed-fps gt 100
                fcs/fly-by-wire/digital-backup == 0
            </test>
            <output>/controls/flight/elevator-trim</output>
        </switch>

        <fcs_function name="fcs/fly-by-wire/pitch/stick-force-lbf">
			<description>
                LJQC: Stick cmd gradient according to 189675. Stand true for both Analog and Digital FLCS.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/elevator-cmd-norm</independentVar>
                    <tableData>
                       -1   31.25
                        0    0
                        1  -31.25
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/command-g">
			<description>
                LJQC: Stick cmd gradient according to 189675. Stand true for both Analog and Digital FLCS.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/stick-force-lbf</independentVar>
                    <tableData>
                       -31.25  -10.86
                        -5.25  -0.44
                        -1.75   0.0
                         1.75   0.0
                         5.25   0.44 
                        31.25  10.86
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <aerosurface_scale name="fcs/fly-by-wire/pitch/trim-scaled">
            <input>fcs/pitch-trim-cmd-norm</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </domain>
            <range>
                <min>  2.4 </min>
                <max> -2.4 </max>
            </range>
        </aerosurface_scale>

        <summer name="fcs/fly-by-wire/pitch/command-sum">
            <input>fcs/fly-by-wire/pitch/trim-scaled</input>
            <input>fcs/fly-by-wire/pitch/command-g</input>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/negative-g-limit-final">
            <description>
                The second test is for MPO switch enabled.
                Source: The Israeli document.
            </description>
            <default value="fcs/fly-by-wire/pitch/F1"/>
            <test logic="OR" value="-4">
                fcs/fly-by-wire/condition-a == 1
                fcs/fbw-override == 1
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/pitch/g-limit">
			<description>
                LJQC: Max g according to 189675.
            </description>
            <input>fcs/fly-by-wire/pitch/command-sum</input>
            <clipto>
                <min>fcs/fly-by-wire/pitch/negative-g-limit-final</min>
                <max>8.3</max>
            </clipto>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/g-limit-product">
            <description>
                The second test is for MPO switch enabled.
                Source: The Israeli document.
            </description>
            <default value="0.5"/>
            <test logic="AND" value="1.0">
                fcs/fly-by-wire/MLG-GND == 1
            </test>
            <test logic="AND" value="1.0">
                fcs/fbw-override == 1
                aero/alpha-deg   gt 29
            </test>
        </switch>

        <pure_gain name="fcs/fly-by-wire/pitch/g-limit-gain">
            <input>fcs/fly-by-wire/pitch/g-limit</input>
            <gain> fcs/fly-by-wire/pitch/g-limit-product </gain>
        </pure_gain>

        <lag_filter name="fcs/fly-by-wire/pitch/command-final">
            <input> fcs/fly-by-wire/pitch/g-limit-gain </input>
            <c1> 8.3 </c1>
        </lag_filter>

        <switch name="fcs/fly-by-wire/pitch/alpha-indicated">
            <description>
                GR1F-16CJ-1 page 1-137
                When NLG WOW occurs, all AOA indications are based on
                zero degrees.
                GR1F-16CJ-1 page 1-120
                DBU - AOA indications do not set to zero and random AOA
                indications are possible in gusty wind conditions
                with NLG WOW.
            </description>
            <default value="aero/alpha-deg"/>
            <test logic="AND" value="0">
                gear/unit[0]/WOW eq 1
                fcs/fly-by-wire/digital-backup == 0
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/pitch/alpha-indicated-clamp">
			<description>
                LJQC: 189675 value.
            </description>
            <input>aero/alpha-deg</input><!-- should really be indicated -->
            <clipto>
                <min>-5.5</min>
                <max>32.5</max>
            </clipto>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/alpha-indicated-switch">
            <default value="fcs/fly-by-wire/pitch/alpha-indicated-clamp"/>
            <test logic="AND" value="0">
                fcs/fly-by-wire/MLG-GND == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/pitch/control-c/roll-rate-abs">
            <function>
                <abs>
                    <product>
                        <property> velocities/p-rad_sec </property>
                        <v> 57.29577951308233 </v>
                    </product>
                </abs>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/pitch/control-c/roll-rate-gain">
            <input>fcs/fly-by-wire/pitch/control-c/roll-rate-abs</input>
            <gain> 0.15 </gain>
        </pure_gain>

        <lag_filter name="fcs/fly-by-wire/pitch/control-c/roll-rate-lagged">
            <input> fcs/fly-by-wire/pitch/control-c/roll-rate-gain </input>
            <c1> 0.67 </c1>
        </lag_filter>

        <fcs_function name="fcs/fly-by-wire/pitch/control-c/roll-rate-schedule">
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/control-c/roll-rate-lagged</independentVar>
                    <tableData>
                          3      0
                        8.4    5.4
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/control-c-actual">
            <description>
                GR1F-16CJ-1 page 120
                DBU - There is no roll rate input to the AOA limiter.
            </description>
            <default value="fcs/fly-by-wire/enable-control-c"/>
            <test value="0">
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <pure_gain name="fcs/fly-by-wire/pitch/control-c/da_p">
            <description>
                I just named this control-c since it uses the
                same enable switch, its really control-b.

                da_p is factored in 3 places in pitch system.
                      Purpose is to reduce inertia-coupling pitch-out departures
                      when rolling at high angle of attack.
                      its not used in yaw, ari or roll.
            </description>
            <input> fcs/fly-by-wire/pitch/control-c/roll-rate-schedule </input>
            <gain> fcs/fly-by-wire/control-c-actual </gain>
        </pure_gain>

        <lag_filter name="fcs/fly-by-wire/pitch/a_f">
            <description>
                        Exit A
            </description>
            <input> fcs/fly-by-wire/pitch/alpha-indicated-switch </input>
            <c1> 10 </c1>
        </lag_filter>

        <summer name="fcs/fly-by-wire/pitch/alpha-sum">
            <description></description>
            <input> fcs/fly-by-wire/pitch/a_f </input>
            <input> fcs/fly-by-wire/pitch/control-c/da_p </input>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/alpha-indicated-mpo">
            <description>
                The test is for MPO switch enabled.
                Source: The Israeli document.

                Since this is part of pitch limiter scheme it
                uses alpha-sum instead of a_f.
            </description>
            <default value="fcs/fly-by-wire/pitch/alpha-sum"/>
            <test logic="AND" value="0"><!-- consider to lag this 0 -->
                fcs/fbw-override == 1
                aero/alpha-deg   gt 29
            </test>
        </switch>

        <switch name="fcs/fly-by-wire/pitch/enable-cat-III">
            <description>
                GR1F-16CJ-1 page 120
                DBU - Stick commands are essentially CAT III limited.
            </description>
            <default value="fcs/fly-by-wire/enable-cat-III"/>
            <test value="1">
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/pitch/alpha-reduction">
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/enable-cat-III</independentVar>
                    <independentVar lookup="column">inertia/weight-lbs</independentVar>
                    <tableData>
                                25000 30000 35000
                          0     -20.4 -20.4 -20.4
                          1     -11.6 -12.4 -13.4
                    </tableData>
                </table>
            </function>
        </fcs_function>
 
        <fcs_function name="fcs/fly-by-wire/pitch/alpha-indicated-sum">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/pitch/alpha-indicated-mpo </property>
                    <p> fcs/fly-by-wire/pitch/alpha-reduction </p>
                    <property> fcs/fly-by-wire/pitch/pitch-rate-gain </property>
                </sum>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/pitch/high-alpha-cmd-neutralizer">
            <description></description>
            <input>fcs/fly-by-wire/pitch/alpha-indicated-sum</input>
            <gain> 0.5 </gain>
            <clipto>
                <min> 0 </min>
                <max>10000</max>
            </clipto>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/command-neutralized-by-high-alpha">
            <input> -fcs/fly-by-wire/pitch/command-final </input>
            <input> fcs/fly-by-wire/pitch/high-alpha-cmd-neutralizer </input>
            <input> -autoflight/pitch/g-demand-switched </input><!-- autopilot input -->
        </summer>

        <pure_gain name="velocities/q-deg_sec">
            <input>velocities/q-rad_sec</input>
            <gain> 57.2957795 </gain>
        </pure_gain>
		
		<lag_filter name="fcs/fly-by-wire/pitch/q-lagged">
          <input> velocities/q-deg_sec </input>
          <c1> 50 </c1>
        </lag_filter>

        <washout_filter name="fcs/fly-by-wire/pitch/q-washout">
          <input> velocities/q-deg_sec </input>
          <c1> 1 </c1>
        </washout_filter>

        <pure_gain name="fcs/fly-by-wire/pitch/q-gain-1">
            <input>fcs/fly-by-wire/pitch/q-washout</input>
            <gain> 0.7 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-gain">
            <input>fcs/fly-by-wire/pitch/q-gain-1</input>
            <gain> fcs/fly-by-wire/pitch/F3 </gain>
        </pure_gain>

        <switch name="fcs/fly-by-wire/pitch/bias-top">
            <description>
                In documents this is 6 instead of 11.
                However due to landing AoA should be 11 to 15,
                The 6 bias is changed to 11.
                DNU
				
				LJQC: Since AOA is nulled upon MLG WOW, so no such switch in 189675.
            </description>
            <default value="0"/>
            <test logic="AND" value="0">
                fcs/fly-by-wire/MLG-GND == 1                
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/pitch/bias-number">
            <description>
                In documents this is 1 and 9 instead of -4 and 4.
                However due to landing AoA should be 11 to 15,
                The 6 bias is changed to 11, and these numbers
                changed so its still 15 in flight CAT I and
                7 in flight CAT III at 100 KCAS.
                DNU
				
				LJQC: Fixed 15.0 in 189675, unrelated to CAT I/III or landing gains.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/enable-cat-III</independentVar>
                    <independentVar lookup="column">velocities/vc-kts</independentVar>
                    <tableData>
                           100 420
                        0    15   15
                        1    15   15
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/pitch/bias-bottom">
            <description>
                Diagram say condition A, changed so this don't kick in
                when doing AAR.
				
				LJQC: 15 bias no change in AAR.
            </description>
            <default value="0"/>
            <test logic="OR" value="0">
                gear/gear-cmd-norm == 1
            </test>
        </switch>

        <lag_filter name="fcs/fly-by-wire/pitch/bias-top-lag">
            <description>
                DNU
            </description>
            <input> fcs/fly-by-wire/pitch/bias-top </input>
            <c1> 10 </c1>
        </lag_filter>
        
        <!--<actuator name="fcs/fly-by-wire/pitch/bias-top-lag">
            <description>
                In diagram this is 10 lag filter.
                
                DNU
            </description>
          <input> fcs/fly-by-wire/pitch/bias-top </input>
          <lag> 10 </lag>
          <rate_limit sense="incr"> 1 </rate_limit>
          <rate_limit sense="decr"> 3 </rate_limit>
          <bias> 0 </bias>
          <deadband_width> 0 </deadband_width>
          <hysteresis_width> 0 </hysteresis_width>
        </actuator>-->

        <lag_filter name="fcs/fly-by-wire/pitch/bias-bottom-lag">
            <description>
                Diagram say 0.125, but that takes 30 seconds to change.
                So 1.25 now, thats about 5 seconds.
                DNU
            </description>
            <input> fcs/fly-by-wire/pitch/bias-bottom </input>
            <c1> 1.25 </c1>
        </lag_filter>

        <summer name="fcs/fly-by-wire/pitch/bias1">
            <input> -fcs/fly-by-wire/pitch/bias-bottom-lag </input><!-- bottom bias -->
            <input> fcs/fly-by-wire/pitch/bias-number </input><!-- middle bias -->
        </summer>

        <summer name="fcs/fly-by-wire/pitch/bias-final">
            <description>
                              docs  niko
                In air:         15    15
                On approach:     6    11
                On ground:       0     0
                
                In air it only react with pitch down when AoA is above 15.
                With gears down it resist with counter pitch whenever the AoA is
                above or below 11, to keep it at 11.
                On ground the bias dont matter. Although if AoA is above
                20.4 another system will react with neutralizing the commanded pitch up.
            </description>
            <input> fcs/fly-by-wire/pitch/bias-top-lag </input><!-- top bias -->
            <input> fcs/fly-by-wire/pitch/bias1 </input>
        </summer>

        <summer name="fcs/fly-by-wire/pitch/pitch-rate-gain-sum">
            <description>
                         Since this is part of pitch limiter scheme it
                         uses alpha-sum instead of a_f.
            </description>
            <input>fcs/fly-by-wire/pitch/alpha-sum</input>
            <input> fcs/fly-by-wire/pitch/pitch-rate-gain </input>
            <input> -fcs/fly-by-wire/pitch/bias-final </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain">
            <input>fcs/fly-by-wire/pitch/pitch-rate-gain-sum</input>
            <gain> 0.161 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-upper">
            <input>fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain</input>
            <gain> 1 </gain>
            <clipto>
                <min> 0 </min>
                <max>10000</max>
            </clipto>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-lower">
			<description>
                    LJQC: This part not exist in Analog or Digital FLCS.
					1F-16CJ-1: Pitch rate command until 10 deg AOA.
            </description>
            <input>fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain</input>
            <gain> 0 </gain>
        </pure_gain>

        <switch name="fcs/fly-by-wire/pitch/pitch-rate-lower-switch">
            <description>
                Is 1.0 or 10 in diagram. Probably 1.0
                DNU
                
                It makes negative pitch rate (washed out) plus alpha (minus a bias)
                give zero input on FBW when gear is up. And x0.1 influence with gear down.
                
                In diagram relies only on Condition A, but its not helpful during AAR,
                nor right after take-off, it should really only get into effect when on
                approach, hence that test.
				
				LJQC: Switch for cruise gains and landing gains.
            </description>
            <default value="0"/>
            <test logic="AND" value="1">
                fcs/fly-by-wire/condition-a == 1
            </test>
        </switch>

        <!--<lag_filter name="fcs/fly-by-wire/pitch/pitch-rate-lower-lag">
            <description>
                Diagram say 0.125, but that does a pitch up for too long after takeoff
                DNU
            </description>
            <input> fcs/fly-by-wire/pitch/pitch-rate-lower-switch </input>
            <c1> 1.25 </c1>
        </lag_filter>-->
        
        <actuator name="fcs/fly-by-wire/pitch/pitch-rate-lower-lag">
            <description>
                2 secs to decrease to zero, when retracting gears.
                25 secs to increase to 0.1, which is time enough to get gear up
                from take-off.
                
                In diagram this is 0.125 lag filter.
                
                DNU
            </description>
          <input> fcs/fly-by-wire/pitch/pitch-rate-lower-switch </input>
          <lag> 20 </lag>
          <rate_limit sense="incr"> 0.04 </rate_limit>
          <rate_limit sense="decr"> 0.50 </rate_limit>
          <bias> 0 </bias>
          <deadband_width> 0 </deadband_width>
          <hysteresis_width> 0 </hysteresis_width>
        </actuator>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-lower-gain">
            <input>fcs/fly-by-wire/pitch/pitch-rate-lower</input>
            <gain> fcs/fly-by-wire/pitch/pitch-rate-lower-lag </gain>
        </pure_gain>

        <fcs_function name="fcs/fly-by-wire/pitch/normal-1">
            <function>
                    <difference>
                        <property> accelerations/a_n </property>
                        <value> 1 </value>
                    </difference>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/pitch/normal-1-special">
            <description>This prevents NaN to propagate through the system</description>
            <default value="0"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/normal-1">
                accelerations/a_n lt  1000
                accelerations/a_n gt -1000
            </test>
        </switch>

        <pure_gain name="fcs/fly-by-wire/pitch/normal-gain">
            <input>fcs/fly-by-wire/pitch/normal-1-special</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/q-washout-gained">
            <input>fcs/fly-by-wire/pitch/q-washout</input>
            <gain> 0.167 </gain>
        </pure_gain>
        
        <pure_gain name="fcs/fly-by-wire/pitch/q-lagged-gained">
            <input>fcs/fly-by-wire/pitch/q-lagged</input>
            <gain> 0.25 </gain>
        </pure_gain>
		
		<fcs_function name="fcs/fly-by-wire/pitch/pitch-rate-cmd-sum">
			<description>
				LJQC: (AOA - 10)
            </description>
            <function>
                    <difference>
                        <property> fcs/fly-by-wire/pitch/a_f </property>
                        <value> 10 </value>
                    </difference>
            </function>
        </fcs_function>
		
		<pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-cmd-gained">
			<description>
				LJQC: (AOA - 10)*0.305, take pos val, and adds to the pitch rate feedback path.
            </description>
            <input>fcs/fly-by-wire/pitch/pitch-rate-cmd-sum</input>
            <gain> 0.305 </gain>
			<clipto>
                <min> 0 </min>
                <max>10000</max>
            </clipto>
        </pure_gain>
        

        <summer name="fcs/fly-by-wire/pitch/pitch-rate-gain-path">
            <input>fcs/fly-by-wire/pitch/q-lagged-gained </input>
			<input> fcs/fly-by-wire/pitch/pitch-rate-cmd-gained </input>
        </summer>
		
		<pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-gain-path-final">
            <input>fcs/fly-by-wire/pitch/pitch-rate-gain-path </input>
            <gain> fcs/fly-by-wire/condition-z </gain>
        </pure_gain>
		
		<summer name="fcs/fly-by-wire/pitch/normal-gain-path">
            <input>fcs/fly-by-wire/pitch/q-washout-gained </input>
			<input> fcs/fly-by-wire/pitch/normal-gain </input>
        </summer>
        
        <pure_gain name="fcs/fly-by-wire/pitch/normal-gain-path-final">
            <input>fcs/fly-by-wire/pitch/normal-gain-path </input>
            <gain> fcs/fly-by-wire/condition-y </gain>
        </pure_gain>
        
        <summer name="fcs/fly-by-wire/pitch/n-and-pitch-rate-combined">
            <input> fcs/fly-by-wire/pitch/normal-gain-path-final </input>
            <input> fcs/fly-by-wire/pitch/pitch-rate-gain-path-final </input>
        </summer>
        
        <summer name="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-combined">
            <input> fcs/fly-by-wire/pitch/pitch-rate-upper </input>
            <input> fcs/fly-by-wire/pitch/pitch-rate-lower-gain </input>
            <input> fcs/fly-by-wire/pitch/n-and-pitch-rate-combined </input>
        </summer>
		
		<lag_filter name="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lagged">
			<description>
				LJQC: Additional lag filter when MLG WOW
			</description>
            <input> fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-combined </input>
            <c1> 17.2 </c1>
        </lag_filter>
		
		<switch name="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lag-switch">
            <default value="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-combined"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lagged">
                fcs/fly-by-wire/MLG-GND == 1
            </test>
        </switch>

        <lead_lag_filter name="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lead-lagged">
            <input> fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lag-switch </input>
            <c1> 3 </c1>
            <c2> 12 </c2>
            <c3> 1 </c3>
            <c4> 12 </c4>
        </lead_lag_filter>
       
        <second_order_filter name="fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-demand">
            <description>
                on old diagram looks to be 2.5, not 2 nor 25
                DNU
            </description>
            <input> fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-lead-lagged </input>
            <c1> 2.5 </c1>
            <c2> 20 </c2>
            <c3> 3500 </c3>
            <c4> 1 </c4>
            <c5> 40 </c5>
            <c6> 3500 </c6>
        </second_order_filter>
        
        <summer name="fcs/fly-by-wire/pitch/error">
            <input> fcs/fly-by-wire/pitch/command-neutralized-by-high-alpha </input>
            <input> fcs/fly-by-wire/pitch/alpha-and-n-and-pitch-rate-demand </input>
        </summer>

    </channel>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    


    <channel execrate="1" name="Pitch Integrator loop and surfaces">

        <pure_gain name="fcs/fly-by-wire/pitch/main-error">
            <input>fcs/fly-by-wire/pitch/error</input>
            <gain> 3.0 </gain>
        </pure_gain>

        <!--<switch name="fcs/fly-by-wire/pitch/loop-schedule">
            <description>                
            </description>
            <default value="fcs/fly-by-wire/pitch/F3"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/F3-loop-alt">
                fcs/fly-by-wire/prototype == 0
            </test>
        </switch>-->

        <pure_gain name="fcs/fly-by-wire/pitch/main-error-scheduled">
            <description>
            </description>
            <input>fcs/fly-by-wire/pitch/main-error</input>
            <gain> fcs/fly-by-wire/pitch/F3 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/integrator-feedback">
            <input> fcs/fly-by-wire/pitch/main-error-scheduled </input>
            <input> -fcs/fly-by-wire/pitch/integrator-feedback-gain </input>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/integrator-feedback-mlg">
            <default value="fcs/fly-by-wire/pitch/integrator-feedback"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/ground-input">
                fcs/fly-by-wire/MLG-GND == 1
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/pitch/integrator-pre">
            <input> fcs/fly-by-wire/pitch/integrator-feedback-mlg </input>
            <input> -fcs/fly-by-wire/pitch/amplifier </input>
            <input> -fcs/fly-by-wire/pitch/int-balance </input>
        </summer>

        <integrator name="fcs/fly-by-wire/pitch/integrator">
            <description>
                Main component of pitch FBW system.
                
                - rect, for a rectangular integrator
                - trap, for a trapezoidal integrator (default)
                - ab2, for a second order Adams Bashforth integrator
                - ab3, for a third order Adams Bashforth integrator
            </description>
            <input> fcs/fly-by-wire/pitch/integrator-pre </input>
            <trigger>fcs/fly-by-wire/pitch/integrator-trigger</trigger>
            <c1 type="ab2"> 5 </c1>
        </integrator>

        <pure_gain name="fcs/fly-by-wire/pitch/ground-input">
            <description>
                Diagram say 0.5, but negative makes more sense.
                AFSC 32657C diagram says -0.5, so yes indeed.
                Negative will limit the integrator action when on ground.
                DNU
            </description>
            <input>fcs/fly-by-wire/pitch/integrator</input>
            <gain> -0.5 </gain>
        </pure_gain>

        <deadband name="fcs/fly-by-wire/pitch/amp-deadzone">
          <input> fcs/fly-by-wire/pitch/integrator </input>
          <width> 50 </width>
        </deadband>

        <pure_gain name="fcs/fly-by-wire/pitch/amplifier">
            <input>fcs/fly-by-wire/pitch/amp-deadzone</input>
            <gain> fcs/fly-by-wire/K_A </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/integrator-post">
            <input> fcs/fly-by-wire/pitch/integrator </input>
            <input> fcs/fly-by-wire/pitch/main-error-scheduled </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/integrator-selftest">
            <input>fcs/fly-by-wire/pitch/integrator-post</input>
            <gain> fcs/fly-by-wire/integrator-selftest-value </gain>
        </pure_gain>
        
        <summer name="fcs/fly-by-wire/pitch/int-balance-summer">
            <description></description>
            <input> fcs/fly-by-wire/pitch/integrator-post </input>
            <input> -fcs/fly-by-wire/pitch/integrator-selftest </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/int-balance">
            <input>fcs/fly-by-wire/pitch/int-balance-summer</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <!--<summer name="fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum">
            <input> fcs/fly-by-wire/pitch/integrator-post </input>
            <input> fcs/fly-by-wire/pitch/alpha-feedback </input>
        </summer>-->

        <deadband name="fcs/fly-by-wire/pitch/integrator-feedback-deadzone">
            <description>
                         It deceptionally looks like 23 on diagram.
                         But it +-25 since that the actuatorlimit.
            </description>
            <input> fcs/fly-by-wire/pitch/integrator-almost-final </input>
            <width> 50 </width>
        </deadband>

        <pure_gain name="fcs/fly-by-wire/pitch/integrator-feedback-gain">
            <input>fcs/fly-by-wire/pitch/integrator-feedback-deadzone</input>
            <gain> 5 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/alpha-feedback">
            <description>
                         Since this is part of pitch limiter scheme it
                         uses alpha-sum instead of a_f.
            </description>
            <input>fcs/fly-by-wire/pitch/alpha-sum</input>
            <gain> fcs/fly-by-wire/pitch/F2 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/integrator-almost-final">
            <input> fcs/fly-by-wire/pitch/integrator-post </input>
            <input> fcs/fly-by-wire/pitch/alpha-feedback </input>
        </summer>

        <summer name="fcs/fly-by-wire/pitch/integrator-final">
            <input> fcs/fly-by-wire/pitch/alpha-feedback </input>
            <input> fcs/fly-by-wire/pitch/integrator-selftest </input>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/integrator-final-elec">
            <description>                
            </description>
            <default value="fcs/fly-by-wire/pitch/integrator-final"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/integrator-final-elec">
                elec/bus/flcc/a lt 20
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/pitch/right-sum">
            <input> fcs/fly-by-wire/pitch/integrator-final-elec </input>
            <input> fcs/fly-by-wire/roll/inter-schedule </input> 
        </summer>

        <summer name="fcs/fly-by-wire/pitch/left-sum">
            <input> fcs/fly-by-wire/pitch/integrator-final-elec </input>
            <input> -fcs/fly-by-wire/roll/inter-schedule </input>
        </summer>

        <switch name="fcs/fly-by-wire/pitch/gravity-speed">
            <description>
                
            </description>
            <default value="0.025"/>
            <test  logic="OR" value="5">
                systems/hydraulics/sysa-psi ge 2000
                systems/hydraulics/sysb-psi ge 2000
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/pitch/gravity-target-right">
            <description>
                
            </description>
            <default value="0"/>
            <test  logic="OR" value="fcs/fly-by-wire/pitch/right-sum">
                systems/hydraulics/sysa-psi ge 2000
                systems/hydraulics/sysb-psi ge 2000
            </test>
            <test logic="AND" value="50">
                gear/unit[0]/WOW eq 1
                gear/unit[1]/WOW eq 1
                gear/unit[2]/WOW eq 1
            </test>
        </switch>

        <actuator name="fcs/fly-by-wire/pitch/gravity-droop-right">
            <description>
                
            </description>
          <input> fcs/fly-by-wire/pitch/gravity-target-right </input>
          <!--lag> 40 </lag-->
          <rate_limit sense="incr"> fcs/fly-by-wire/pitch/gravity-speed </rate_limit>
          <rate_limit sense="decr"> 5 </rate_limit>
          <bias> 0 </bias>
          <deadband_width> 0 </deadband_width>
          <hysteresis_width> 0 </hysteresis_width>
        </actuator>

        <switch name="fcs/fly-by-wire/pitch/gravity-target-left">
            <description>
                
            </description>
            <default value="0"/>
            <test  logic="OR" value="fcs/fly-by-wire/pitch/left-sum">
                systems/hydraulics/sysa-psi ge 2000
                systems/hydraulics/sysb-psi ge 2000
            </test>
            <test logic="AND" value="50">
                gear/unit[0]/WOW eq 1
                gear/unit[1]/WOW eq 1
                gear/unit[2]/WOW eq 1
            </test>
        </switch>

        <actuator name="fcs/fly-by-wire/pitch/gravity-droop-left">
            <description>
                
            </description>
          <input> fcs/fly-by-wire/pitch/gravity-target-left </input>
          <!--lag> 40 </lag-->
          <rate_limit sense="incr"> fcs/fly-by-wire/pitch/gravity-speed </rate_limit>
          <rate_limit sense="decr"> 5 </rate_limit>
          <bias> 0 </bias>
          <deadband_width> 0 </deadband_width>
          <hysteresis_width> 0 </hysteresis_width>
        </actuator>

        <switch name="fcs/fly-by-wire/pitch/right-hyd">
          <default value="fcs/fly-by-wire/pitch/gravity-droop-right"/>
          <test  logic="OR" value="fcs/fly-by-wire/pitch/right-sum">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

         <switch name="fcs/fly-by-wire/pitch/left-hyd">
          <default value="fcs/fly-by-wire/pitch/gravity-droop-left"/>
          <test  logic="OR" value="fcs/fly-by-wire/pitch/left-sum">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <!-- servos -->

        <!--<second_order_filter name="fcs/fly-by-wire/pitch/right-servo">
            <description>
                Ref.: TN D-8176
                Servodynamics
                Disabled due to too slow to react to changes?
            </description>
            <input> fcs/fly-by-wire/pitch/right-hyd </input>
            <c1> 0 </c1>
            <c2> 0 </c2>
            <c3> 2704 </c3>
            <c4> 1 </c4>
            <c5> 72.8 </c5>
            <c6> 2704 </c6>
        </second_order_filter>

        <second_order_filter name="fcs/fly-by-wire/pitch/left-servo">
            <input> fcs/fly-by-wire/pitch/left-hyd </input>
            <c1> 0 </c1>
            <c2> 0 </c2>
            <c3> 2704 </c3>
            <c4> 1 </c4>
            <c5> 72.8 </c5>
            <c6> 2704 </c6>
        </second_order_filter>-->

        <lag_filter name="fcs/fly-by-wire/pitch/right-lag">
            <description>Power actuator dynamics</description>
            <input> fcs/fly-by-wire/pitch/right-hyd </input>
            <c1> 20 </c1>
        </lag_filter>

        <lag_filter name="fcs/fly-by-wire/pitch/left-lag">
            <description>Power actuator dynamics</description>
            <input> fcs/fly-by-wire/pitch/left-hyd </input>
            <c1> 20 </c1>
        </lag_filter>

        <kinematic name="fcs/fly-by-wire/pitch/horz-tail-right-deflection-deg">
            <description>
                defl. limit = 25, rate limit = 60 deg/s
            </description>
            <input>fcs/fly-by-wire/pitch/right-lag</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -25.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  25.0 </position>
                    <time>      0.8333 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -25 </min>
                <max>  25 </max>
            </clipto>
        </kinematic>

        <kinematic name="fcs/fly-by-wire/pitch/horz-tail-left-deflection-deg">
            <input>fcs/fly-by-wire/pitch/left-lag</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -25.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  25.0 </position>
                    <time>      0.8333 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -25 </min>
                <max>  25 </max>
            </clipto>
        </kinematic>

        <!-- resulting deflection for aerodynamics -->

        <summer name="fcs/fly-by-wire/pitch/horz-tail-deflection-combined-deg">
            <input> fcs/fly-by-wire/pitch/horz-tail-left-deflection-deg </input>
            <input> fcs/fly-by-wire/pitch/horz-tail-right-deflection-deg </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/horz-tail-deflection-deg">
            <input>fcs/fly-by-wire/pitch/horz-tail-deflection-combined-deg</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <aerosurface_scale name="fcs/fly-by-wire/pitch/horz-tail-deflection-norm">
          <input>fcs/fly-by-wire/pitch/horz-tail-deflection-deg</input>
          <domain>
            <min>-25</min>
            <max>25</max>
          </domain>
          <range>
            <min>-1</min>
            <max>1</max>
          </range>
        </aerosurface_scale>

        <fcs_function name="fcs/fly-by-wire/pitch/block15-horz-tail-factor">
            <description>
                Block-15 and above had the horizontal tail surface enlarged
                by 25% for better control. This data does not factor that in
                so do it ourselves.

                Basically larger value will make the deep stall worse.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/horz-tail-deflection-deg</independentVar>
                    <tableData>
                     -25.0      1.25
                      0.0       1.0
                      25.0      1.25
                    </tableData>
                </table>
            </function>
        </fcs_function>

    </channel><!-- end of pitch channels -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <channel execrate="1" name="Roll">

        <fcs_function name="fcs/fly-by-wire/roll/stick-force-lbf">
            <function>
                <table>
                    <independentVar lookup="row">fcs/aileron-cmd-norm</independentVar>
                    <tableData>
                       -1 -17.57
                        0   0
                        1  17.57
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/control-c/pressure-input">
            <function>
                <product>
                    <min>
                        <sum>
                            <p>fcs/fly-by-wire/q_c_Nsqm</p>
                            <v>-10500</v>
                        </sum>
                        <v>0</v>
                    </min>
                    <v>-0.0115</v>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/control-c/alpha-input">
            <function>
                <product>
                    <max>
                        <sum>
                            <p>fcs/fly-by-wire/pitch/a_f</p>
                            <v>-15</v>
                        </sum>
                        <v>0</v>
                    </max>
                    <v>4</v>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/control-c/elevator-cmd-input">
            <description>
                The -1 factor was removed since it was wrong. When more than
                5 deg nosedown elev is commanded this comes into effect.
            </description>
            <function>
                <product>
                    <max>
                        <sum>
                            <!--<product>-->
                                <p>fcs/fly-by-wire/pitch/integrator-final</p>
                                <!--<v>-1</v>
                            </product>-->
                            <v>-4.2</v>
                        </sum>
                        <v>0</v>
                    </max>
                    <v>4</v>
                </product>
            </function>
        </fcs_function>
		
		<switch name="fcs/fly-by-wire/roll/bias-catiii">
            <description>
                LJQC: 136 deg/s cat-III bias is actually added to the roll rate limiter, max limited by 244.
            </description>
            <default value="0"/>
            <test logic="OR" value="136">
                fcs/fly-by-wire/enable-cat-III == 1                
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/roll/control-c/input-sum">
            <input>fcs/fly-by-wire/roll/control-c/pressure-input</input>
            <input>fcs/fly-by-wire/roll/control-c/alpha-input</input>
            <input>fcs/fly-by-wire/roll/control-c/elevator-cmd-input</input>
			<input>fcs/fly-by-wire/roll/bias-catiii</input>
        </summer>

        <fcs_function name="fcs/fly-by-wire/roll/control-c/scheduled-gain-limited">
            <function>
                <min>
                    <v>244</v>
                    <product>
                        <table>
                            <independentVar lookup="row">fcs/fly-by-wire/pitch/control-c/roll-rate-abs</independentVar>
                            <tableData>
                                30 1 <!-- not exist in 189675 -->
                                50 1
                            </tableData>
                        </table>
                        <p>fcs/fly-by-wire/roll/control-c/input-sum</p>
                    </product>
                </min>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/control-c/max-cmd-roll-rate">
            <function>
                <difference>
                    <v>324</v>
                    <p>fcs/fly-by-wire/roll/control-c/scheduled-gain-limited</p>
                </difference>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/roll/max-cmd-roll-rate">
            <description>
                GR1F-16CJ-1 page 120
                DBU - Maximum roll rate command is a constant 167 degrees per second.
            </description>
            <default value="324"/>
            <test logic="OR" value="fcs/fly-by-wire/roll/control-c/max-cmd-roll-rate">
                fcs/fly-by-wire/control-c-actual == 1
            </test>
        </switch>
		
		<switch name="fcs/fly-by-wire/roll/max-cmd-roll-rate-gain-switch">
            <description>
                LJQC: According to 189675, 167deg/s is a direct overriding limit by roll rate command limiter, instead of applying a 0.542208 gain.
            </description>
            <default value="fcs/fly-by-wire/roll/max-cmd-roll-rate"/>
            <test logic="OR" value="167">
                fcs/fly-by-wire/condition-a == 1
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/roll/min-cmd-roll-rate">
            <function>
                <quotient>
                    <p>fcs/fly-by-wire/roll/max-cmd-roll-rate-gain-switch</p>
                    <v>324</v>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/roll/command-deg_s">
			<description>
                LJQC: command gradient according to 189675.
            </description>
            <function>
                <product>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/roll/stick-force-lbf</independentVar>
                    <tableData>
                        -17.57  -324 
                        -9      -80 
                        -5      -20  
                        -1      0  
                        0       0  
                        1       0   
                        5       20  
                        9       80  
                        17.57   324  
                    </tableData>
                </table>
                <p>fcs/fly-by-wire/roll/min-cmd-roll-rate</p>
                </product>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/roll/enable-cat-III">
            <description>
                GR1F-16CJ-1 page 120
                DBU - Maximum roll rate command is a constant 167 degrees per second.
            </description>
            <default value="fcs/fly-by-wire/enable-cat-III"/>
            <test value="0">
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/roll/command-limited-deg_s">
			<description>
                LJQC: Already accounted for at above. No usage here.
            </description>
            <function>
                <product>
                    <table>
                        <independentVar lookup="row">fcs/fly-by-wire/roll/enable-cat-III</independentVar>
                        <tableData>
                             0  1
                             1  1
                        </tableData>
                    </table>
                    <!--<table>  this is already done in fcs/fly-by-wire/roll/gain-switch
                        <independentVar lookup="row">gear/gear-pos-norm</independentVar>
                        <tableData>
                             0  1
                             1  0.542208
                        </tableData>
                    </table>-->
                    <p>fcs/fly-by-wire/roll/command-deg_s</p>
                </product>
            </function>
        </fcs_function>

        <aerosurface_scale name="fcs/fly-by-wire/roll/trim-scaled">
            <input>fcs/roll-trim-cmd-norm</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </domain>
            <range>
                <min> -40 </min>
                <max>  40 </max>
            </range>
        </aerosurface_scale>
		

        <pure_gain name="fcs/fly-by-wire/roll/ground-gain">
			<description>
                LJQC: Already accounted for at above. No usage here.
            </description>
            <input>fcs/fly-by-wire/roll/command-limited-deg_s</input>
            <gain> 1.0 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/roll/loop-sum">
            <input>fcs/fly-by-wire/roll/ground-gain</input>
            <input>-fcs/fly-by-wire/roll/loop-top-lead</input>
            <input>-fcs/fly-by-wire/roll/loop-bottom-lead</input>
        </summer>

        <lag_filter name="fcs/fly-by-wire/roll/loop-lag">
            <input> fcs/fly-by-wire/roll/loop-sum </input>
            <c1> 10 </c1>
        </lag_filter>

        <summer name="fcs/fly-by-wire/roll/loop-lag-neg">
            <input>fcs/fly-by-wire/roll/loop-lag</input>
            <clipto>
                <min>-10000</min>
                <max>0</max>
            </clipto>
        </summer>

        <summer name="fcs/fly-by-wire/roll/loop-lag-pos">
            <input>fcs/fly-by-wire/roll/loop-lag</input>
            <clipto>
                <min> 0 </min>
                <max> 10000 </max>
            </clipto>
        </summer>

        <lead_lag_filter name="fcs/fly-by-wire/roll/loop-bottom-lead">
          <input> fcs/fly-by-wire/roll/loop-lag-neg </input>
          <c1> 6 </c1>
          <c2> 0 </c2>
          <c3> 1 </c3>
          <c4> 20 </c4>
          <clipto>
                <min>-10000</min>
                <max>0</max>
          </clipto>
        </lead_lag_filter>

        <lead_lag_filter name="fcs/fly-by-wire/roll/loop-top-lead">
          <input> fcs/fly-by-wire/roll/loop-lag-pos </input>
          <c1> 6 </c1>
          <c2> 0 </c2>
          <c3> 1 </c3>
          <c4> 20 </c4>
          <clipto>
            <min> 0 </min>
            <max> 10000 </max>
          </clipto>
        </lead_lag_filter>

        <summer name="fcs/fly-by-wire/roll/loop-sum-end">
            <input>-fcs/fly-by-wire/roll/loop-lag</input>
            <input>-fcs/fly-by-wire/roll/trim-gain</input>
            <input>fcs/fly-by-wire/roll/roll-filter</input>
            <input>-autoflight/roll/roll-rate-demand</input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/roll/trim-gain">
            <input>fcs/fly-by-wire/roll/trim-scaled</input>
            <gain> 1.67 </gain>
        </pure_gain>

        <pure_gain name="velocities/p-deg_sec">
            <input>velocities/p-rad_sec</input>
            <gain> 57.2957795 </gain>
        </pure_gain>

        <second_order_filter name="fcs/fly-by-wire/roll/lead-exit">
            <description>
                Exit B in diagram.
            </description>
            <input> velocities/p-deg_sec </input>
            <c1> 1 </c1>
            <c2> 0 </c2>
            <c3> 3025 </c3>
            <c4> 1 </c4>
            <c5> 0 </c5>
            <c6> 3025 </c6>
        </second_order_filter>

        <second_order_filter name="fcs/fly-by-wire/roll/roll-filter">
          <input> velocities/p-deg_sec </input>
          <c1> 4 </c1>
          <c2> 64 </c2>
          <c3> 6400 </c3>
          <c4> 1 </c4>
          <c5> 80 </c5>
          <c6> 6400 </c6>
        </second_order_filter>

        <pure_gain name="fcs/fly-by-wire/roll/yaw-rate-input">
            <description>
                Is +8.34 in diagram, but must be negative to really work as flat spin protection.
                And for slow flat spins it was way too small.
            </description>
            <input> velocities/r-deg_sec </input>
            <gain> -8.34 </gain>
        </pure_gain>

        <switch name="fcs/fly-by-wire/roll/switch">
            <default value="fcs/fly-by-wire/roll/loop-sum-end"/>
            <test logic="AND" value="fcs/fly-by-wire/roll/yaw-rate-input">
                fcs/fly-by-wire/pitch/a_f ge 29
                fcs/fly-by-wire/prototype == 0
            </test>
        </switch>

        <switch name="fcs/fly-by-wire/roll/switch-elec">
            <description>                
            </description>
            <default value="fcs/fly-by-wire/roll/switch"/>
            <test logic="AND" value="fcs/fly-by-wire/roll/switch-elec">
                elec/bus/flcc/b lt 20
            </test>
        </switch>

        <pure_gain name="fcs/fly-by-wire/roll/final">
            <description></description>
            <input>fcs/fly-by-wire/roll/switch-elec</input>
            <gain> 0.12 </gain>
            <clipto>
                <min> -21.5 </min>
                <max>  21.5 </max>
            </clipto>
        </pure_gain>

        <summer name="fcs/fly-by-wire/roll/top-sum">
            <input>fcs/fly-by-wire/roll/final</input>
            <input>-fcs/fly-by-wire/roll/bottom-deadzone</input>
            <input>fcs/fly-by-wire/tef/tef-pos-deg</input>
        </summer>

        <summer name="fcs/fly-by-wire/roll/bottom-sum">
            <input>-fcs/fly-by-wire/roll/final</input>
            <input>-fcs/fly-by-wire/roll/top-deadzone</input>
            <input>fcs/fly-by-wire/tef/tef-pos-deg</input>
        </summer>

        <fcs_function name="fcs/fly-by-wire/roll/top-deadzone-pos">
            <function>
                <difference>
                    <property> fcs/fly-by-wire/roll/top-sum </property>
                    <value> 21.5 </value>
                </difference>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/roll/top-deadzone">
            <default value="0"/>
            <test logic="AND" value="fcs/fly-by-wire/roll/top-deadzone-pos">
                fcs/fly-by-wire/roll/top-sum gt  21.5
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/roll/bottom-deadzone-pos">
            <function>
                <difference>
                    <property> fcs/fly-by-wire/roll/bottom-sum </property>
                    <value> 21.5 </value>
                </difference>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/roll/bottom-deadzone">
            <default value="0"/>
            <test logic="AND" value="fcs/fly-by-wire/roll/bottom-deadzone-pos">
                fcs/fly-by-wire/roll/bottom-sum gt  21.5
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/roll/bottom-limit">
            <input>fcs/fly-by-wire/roll/bottom-sum</input>
            <clipto>
                <min> -21.5 </min>
                <max>  21.5 </max>
            </clipto>
        </summer>

        <summer name="fcs/fly-by-wire/roll/top-limit">
            <input>fcs/fly-by-wire/roll/top-sum</input>
            <clipto>
                <min> -21.5 </min>
                <max>  21.5 </max>
            </clipto>
        </summer>

        <!--<second_order_filter name="fcs/fly-by-wire/roll/servodynamics-right">
            <description>
                (52)^2
                div
                (s^2+2(.7)(52)S+(52)^2
            </description>
            <input> fcs/fly-by-wire/roll/top-limit </input>
            <c1> 0 </c1>
            <c2> 0 </c2>
            <c3> 2704 </c3>
            <c4> 1 </c4>
            <c5> 72.8 </c5>
            <c6> 2704 </c6>
        </second_order_filter>-->

        <lag_filter name="fcs/fly-by-wire/roll/flaperon-right-lag">
            <description>
                Power actuator dynamics
                rate limit = 80 deg/s
            </description>
            <input> fcs/fly-by-wire/roll/top-limit </input>
            <c1> 20 </c1>
        </lag_filter>

        <fcs_function name="fcs/fly-by-wire/roll/mech-bias-right">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/roll/flaperon-right-lag </property>
                    <value> -1.5 </value>
                </sum>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/roll/mech-bias-hyd-right">
          <default value="0"/>
          <test  logic="OR" value="fcs/fly-by-wire/roll/mech-bias-right">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <kinematic name="fcs/fly-by-wire/roll/flaperon-right-deflection-deg">
            <input>fcs/fly-by-wire/roll/mech-bias-hyd-right</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -80.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  80.0 </position>
                    <time>      2 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -23.0 </min>
                <max>  20.0 </max>
            </clipto>
        </kinematic>

        <aerosurface_scale name="fcs/fly-by-wire/roll/flaperon-right-pos-norm">
            <input>fcs/fly-by-wire/roll/flaperon-right-deflection-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -23.0 </min>
                <max>  20.0 </max>
            </domain>
            <range>
                <min> -1.0 </min>
                <max>  0.8695 </max>
            </range>
        </aerosurface_scale>

        <!--<second_order_filter name="fcs/fly-by-wire/roll/servodynamics-left">
            <description>
                (52)^2
                div
                (s^2+2(.7)(52)S+(52)^2
            </description>
            <input> fcs/fly-by-wire/roll/bottom-limit </input>
            <c1> 0 </c1>
            <c2> 0 </c2>
            <c3> 2704 </c3>
            <c4> 1 </c4>
            <c5> 72.8 </c5>
            <c6> 2704 </c6>
        </second_order_filter>-->

        <lag_filter name="fcs/fly-by-wire/roll/flaperon-left-lag">
            <description>
                Power actuator dynamics
                rate limit = 80 deg/s
            </description>
            <input> fcs/fly-by-wire/roll/bottom-limit </input>
            <c1> 20 </c1>
        </lag_filter>

        <fcs_function name="fcs/fly-by-wire/roll/mech-bias-left">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/roll/flaperon-left-lag </property>
                    <value> -1.5 </value>
                </sum>
            </function>
        </fcs_function>
        
         <switch name="fcs/fly-by-wire/roll/mech-bias-hyd-left">
          <default value="0"/>
          <test  logic="OR" value="fcs/fly-by-wire/roll/mech-bias-left">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <kinematic name="fcs/fly-by-wire/roll/flaperon-left-deflection-deg">
            <input>fcs/fly-by-wire/roll/mech-bias-hyd-left</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -80.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  80.0 </position>
                    <time>      2 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -23.0 </min>
                <max>  20.0 </max>
            </clipto>
        </kinematic>

        <aerosurface_scale name="fcs/fly-by-wire/roll/flaperon-left-pos-norm">
            <input>fcs/fly-by-wire/roll/flaperon-left-deflection-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -23.0 </min>
                <max>  20.0 </max>
            </domain>
            <range>
                <min> -1.0 </min>
                <max>  0.8695 </max>
            </range>
        </aerosurface_scale>

        <summer name="fcs/fly-by-wire/roll/inter-sum">
            <input>-fcs/fly-by-wire/roll/bottom-limit</input>
            <input>fcs/fly-by-wire/roll/top-limit</input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/roll/inter-gain">
            <input>fcs/fly-by-wire/roll/inter-sum</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/roll/inter-schedule">
            <input>fcs/fly-by-wire/roll/inter-gain</input>
            <gain> fcs/fly-by-wire/roll/F10 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/roll/aileron-pos-deg">
            <input>-fcs/fly-by-wire/roll/flaperon-left-deflection-deg</input>
            <input>fcs/fly-by-wire/roll/flaperon-right-deflection-deg</input>
        </summer>

        <aerosurface_scale name="fcs/fly-by-wire/roll/aileron-pos-norm">
            <input>fcs/fly-by-wire/roll/aileron-pos-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -43 </min>
                <max>  43 </max>
            </domain>
            <range>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </range>
        </aerosurface_scale>

    </channel><!-- end of roll channel -->











    <channel execrate="1" name="Aileron Rudder Interconnect">

        <fcs_function name="fcs/fly-by-wire/ari/inverter-norm">
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/a_f</independentVar>
                    <tableData>
                        -10   0.0
                          0   1.0
                         10   0.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/ari/schedule">
            <function>
                <product>
                    <p> fcs/fly-by-wire/ari/inverter-norm </p>
                    <v> 0.65 </v>
                    <p> fcs/fly-by-wire/ari/F7 </p>
                </product>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/ari/gain">
            <input>fcs/fly-by-wire/pitch/a_f</input>
            <gain> 0.0375 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/ari/sum">
            <input>-fcs/fly-by-wire/ari/schedule</input>
            <input>fcs/fly-by-wire/ari/gain</input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/ari/final">
            <description>
                Here the ARI result is multiplied to aileron demand,
                the result is how much ARI contributes to rudder.

                Notice that in TP-1538 the intergain has not been
                multiplied by 0.5. But thats fine due to in that 
                document it is a single aileron value used,
                while here we subtract both aileron values, so
                its double.
            </description>
            <input>fcs/fly-by-wire/ari/sum</input>
            <gain> fcs/fly-by-wire/roll/inter-gain </gain>
            <gain> fcs/fly-by-wire/enable-ari </gain>
        </pure_gain>

    </channel><!-- end of ARI channel -->















    <channel execrate="1" name="Yaw">
        
        <fcs_function name="fcs/rudder-cmd-pow-norm">
            <function>
                    <ifthen>
                        <lt>
                            <p> fcs/rudder-cmd-norm </p>
                            <v> 0 </v>
                        </lt>
                        <product>
                            <v> -1 </v>
                            <pow>
                                <abs>
                                    <p>fcs/rudder-cmd-norm</p>
                                </abs>
                                <v>1.3</v>
                            </pow>
                        </product>
                        <pow>
                            <p>fcs/rudder-cmd-norm</p>
                            <v>1.3</v>
                        </pow>
                    </ifthen>
            </function>
        </fcs_function>

        <kinematic name="fcs/fly-by-wire/yaw/rudder-cmd-norm-kinematic">
            <description>
                Real pedals can not be moved as fast as a joystick.
                This will limit the movement speed.
            </description>
            <input>fcs/rudder-cmd-pow-norm</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -1.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  1.0  </position>
                    <time>      0.75 </time>
                </setting>
            </traverse>
        </kinematic>

        <fcs_function name="fcs/fly-by-wire/yaw/pedal-force-lbf">
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/yaw/rudder-cmd-norm-kinematic</independentVar>
                    <tableData>
                       -1 -120
                        0    0
                        1  120
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/yaw/command-deg">
            <description>
                The +- 15 includes mech preload and electrical breakout.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/yaw/pedal-force-lbf</independentVar>
                    <tableData>
                        -120  30.0
                         -15   0.0
                          15   0.0
                         120 -30.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <aerosurface_scale name="fcs/fly-by-wire/yaw/trim-scaled">
            <input>fcs/yaw-trim-cmd-norm</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </domain>
            <range>
                <min> -8 </min>
                <max>  8 </max>
            </range>
        </aerosurface_scale>

        <summer name="fcs/fly-by-wire/yaw/command-sum">
            <input>fcs/fly-by-wire/yaw/trim-scaled</input>
            <input>-fcs/fly-by-wire/yaw/command-deg</input>
        </summer>

        <switch name="fcs/fly-by-wire/yaw/enable-cat-III">
            <description>
                GR1F-16CJ-1 page 120
                DBU - Rudder pedal commands are essentially CAT I limited.
            </description>
            <default value="fcs/fly-by-wire/enable-cat-III"/>
            <test value="0">
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/yaw/command-schedule">
            <description>
                In Cat I TP-1538 say 20-30, but modern flight manual say 14-26.
                Here I have implemented modern values.

                TODO: Consider using aero/alpha-deg here instead of a_f.
                      TP-1538 does say it uses alpha indicated directly.
            </description>
            <function>
                <product>
                    <table>
                        <independentVar lookup="row">fcs/fly-by-wire/pitch/a_f</independentVar>
                        <independentVar lookup="column">fcs/fly-by-wire/yaw/enable-cat-III</independentVar>
                        <tableData>
                                   0           1
                             3   1.0         1.0
                            14   1.0         0.08333
                            15   0.91666     0.0
                            26   0.0         0.0
                        </tableData>
                    </table>
                    <p>fcs/fly-by-wire/yaw/command-sum</p>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/yaw/control-c/command-schedule">
            <function>
                <product>
                    <table>
                        <independentVar lookup="row">fcs/fly-by-wire/pitch/control-c/roll-rate-abs</independentVar>
                        <independentVar lookup="column">fcs/fly-by-wire/control-c-actual</independentVar>
                        <tableData>
                                   0  1
                            20   1.0 1.0
                            40   1.0 0.0
                        </tableData>
                    </table>
                    <p>fcs/fly-by-wire/yaw/command-schedule</p>
                </product>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/yaw/ari-input">
            <default value="fcs/fly-by-wire/ari/final"/>
            <test logic="AND" value="0">
                fcs/fly-by-wire/pitch/a_f ge 29
                fcs/fly-by-wire/prototype == 0
            </test>
        </switch>

        <switch name="fcs/fly-by-wire/yaw/command-switch">
            <default value="fcs/fly-by-wire/yaw/command-sum"/>
            <test logic="OR" value="fcs/fly-by-wire/yaw/control-c/command-schedule">
                fcs/fly-by-wire/prototype == 0
                fcs/fly-by-wire/prototype == 1 <!-- this is to allow prototype FBW to use control-c -->
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/yaw/command-sum-ari">
            <input>fcs/fly-by-wire/yaw/ari-input</input>
            <input>fcs/fly-by-wire/yaw/command-switch</input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/yaw/g-gain">
            <input>accelerations/a_y</input>
            <gain> 19.32 </gain>
        </pure_gain>

        <pure_gain name="velocities/r-deg_sec">
            <input>velocities/r-rad_sec</input>
            <gain> 57.2957795 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/yaw/cross-gain">
            <input>fcs/fly-by-wire/roll/lead-exit</input>
            <gain> 0.01745 </gain><!-- deg/sec to rad/sec -->
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/yaw/cross-multiplier">
            <input>fcs/fly-by-wire/pitch/a_f</input>
            <gain> fcs/fly-by-wire/yaw/cross-gain </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/yaw/yaw-limits-sum-1">
            <input>velocities/r-deg_sec</input>
            <input>-fcs/fly-by-wire/yaw/cross-multiplier</input>
        </summer>

        <lead_lag_filter name="fcs/fly-by-wire/yaw/lead">
          <input> fcs/fly-by-wire/yaw/yaw-limits-sum-1 </input>
          <c1> 3 </c1>
          <c2> 15 </c2>
          <c3> 1 </c3>
          <c4> 15 </c4>
        </lead_lag_filter>

        <lead_lag_filter name="fcs/fly-by-wire/yaw/lead-second">
          <input> fcs/fly-by-wire/yaw/lead </input>
          <c1> 1.5 </c1>
          <c2> 0 </c2>
          <c3> 1 </c3>
          <c4> 1 </c4>
        </lead_lag_filter>

        <summer name="fcs/fly-by-wire/yaw/yaw-limits-sum-2">
            <input>fcs/fly-by-wire/yaw/lead-second</input>
            <input>fcs/fly-by-wire/yaw/g-gain</input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/yaw/schedule">
            <input>fcs/fly-by-wire/yaw/yaw-limits-sum-2</input>
            <gain> fcs/fly-by-wire/yaw/F8 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/yaw/alt-schedule">
            <description>
                Is +0.75 in diagram.
                TODO: check the validity
            </description>
            <input> velocities/r-deg_sec </input>
            <gain> -0.75 </gain>
        </pure_gain>

        <switch name="fcs/fly-by-wire/yaw/schedule-final">
            <default value="fcs/fly-by-wire/yaw/schedule"/>
            <test logic="AND" value="fcs/fly-by-wire/yaw/alt-schedule">
                fcs/fly-by-wire/pitch/a_f ge 29
                fcs/fly-by-wire/prototype == 0
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/yaw/rudder-sum">
            <input>fcs/fly-by-wire/yaw/schedule-final</input>
            <input>fcs/fly-by-wire/yaw/command-sum-ari</input>
        </summer>

        <switch name="fcs/fly-by-wire/yaw/rudder-sum-elec">
            <description>                
            </description>
            <default value="fcs/fly-by-wire/yaw/rudder-sum"/>
            <test logic="AND" value="fcs/fly-by-wire/yaw/rudder-sum-elec">
                elec/bus/flcc/c lt 20
            </test>
        </switch>

        <second_order_filter name="fcs/fly-by-wire/yaw/struct-filter">
          <input> fcs/fly-by-wire/yaw/rudder-sum-elec </input>
          <c1> 1 </c1>
          <c2> 0 </c2>
          <c3> 1225 </c3>
          <c4> 1 </c4>
          <c5> 0 </c5>
          <c6> 1225 </c6>
        </second_order_filter>

        <!--<second_order_filter name="fcs/fly-by-wire/yaw/servodynamics">
            <description>
                (52)^2
                div
                (s^2+2(.7)(52)S+(52)^2
            </description>
            <input> fcs/fly-by-wire/yaw/struct-filter </input>
            <c1> 0 </c1>
            <c2> 0 </c2>
            <c3> 2704 </c3>
            <c4> 1 </c4>
            <c5> 72.8 </c5>
            <c6> 2704 </c6>
        </second_order_filter>-->

        <lag_filter name="fcs/fly-by-wire/yaw/rudder-lag">
            <description>
                Power actuator dynamics
                Rate limit = 120 deg/s
            </description>
            <input> fcs/fly-by-wire/yaw/struct-filter </input>
            <c1> 20 </c1>
        </lag_filter>

        <switch name="fcs/fly-by-wire/yaw/hyd">
          <default value="0"/>
          <test  logic="OR" value="fcs/fly-by-wire/yaw/rudder-lag">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <kinematic name="fcs/fly-by-wire/yaw/rudder-deflection-deg">
            <input>fcs/fly-by-wire/yaw/hyd</input>
            <noscale/>
            <traverse>
                <setting>
                    <position> -30.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  30.0 </position>
                    <time>      0.5 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -30 </min>
                <max>  30 </max>
            </clipto>
        </kinematic>
         
        <aerosurface_scale name="fcs/fly-by-wire/yaw/rudder-pos-norm">
            <input>fcs/fly-by-wire/yaw/rudder-deflection-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -30.0 </min>
                <max>  30.0 </max>
            </domain>
            <range>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </range>
        </aerosurface_scale>

    </channel><!-- end of yaw channel -->































    <channel name="Throttle" execrate="1">
        
        <switch name="fcs/fly-by-wire/throttle-limit-ab">
            <description>
                Don't allow reheat before N2 has reached 96.5% 
            </description>
            <default value="1.0"/>
            <test logic="AND" value="2.0">
                /engines/engine/n2 gt 96.5
            </test>
        </switch>
        
        <!--<switch name="fcs/fly-by-wire/throttle-max-ab">
            <description>
                MAX POWER switch is solenoid that is held in place at max power when
                at mach 1.1 or higher and throttle at max AB. For later engines than PW 200
                is non-functional.
                
                To switch it OFF is not implemented.
            </description>
            <default value="0"/>
            <test logic="AND" value="0.5">
                /sim/variant-id gt 1
            </test>
            <test logic="AND" value="1">
                fcs/throttle-pos-norm == 2.0
                velocities/mach ge 1.1
            </test>
            <output>/f16/engine/max-power</output>
        </switch>-->
        
        <aerosurface_scale name="fcs/throttle-cmd-deg">
            <description>
                F100 PW throttle (power lever angle)
                
                F100:
                0 deg - Cutoff
                16 deg - Idle
                86 deg - Mil
                91 deg - AB
                130 deg - Full AB
            </description>
            <input>fcs/throttle-cmd-norm</input>
            <zero_centered> false </zero_centered>
            <domain>
                <min>   0.0 </min>
                <max>   1.0 </max>
            </domain>
            <range>
                <min>  16.0 </min><!-- idle -->
                <max> 130.0 </max><!-- full AB -->
            </range>
        </aerosurface_scale>

        <fcs_function name="fcs/fly-by-wire/throttle/pos-norm">
            <description>
                Page 153 of secondary doc. And F-16.net. The mach 1.00 column is a guesstimate.
                
                Thrust is approx linear with PLA.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/throttle-cmd-deg</independentVar>
                    <independentVar lookup="column">velocities/mach</independentVar>
                    <tableData>
                               0.84 1.00 1.40
                       16      0.00 0.43 1.00
                       30      0.43 0.53 1.00
                       44      0.63 0.70 1.00
                       58      0.79 0.85 1.00
                       72      0.89 0.89 1.00
                       86      1.00 1.00 1.00
                       90.99   1.00 1.00 1.00
                      130      2.00 2.00 2.00
                    </tableData>
                </table>
            </function>
            <clipto>
                <min>  0 </min>
                <max>  fcs/fly-by-wire/throttle-limit-ab </max>
            </clipto>
            <output>fcs/throttle-pos-norm</output>
        </fcs_function>
        
        <fcs_function name="/controls/engines/engine[0]/throttle-movement">
            <description>
                At idle the throttle will be at 12.3% of full throttle movement.
            </description>
            <function>
                <table>
                    <independentVar lookup="row">fcs/throttle-cmd-deg</independentVar>
                    <independentVar lookup="column">/f16/engine/cutoff-release-lever</independentVar>                    
                    <tableData>
                                  0      1
                       16.0       0.123  0
                      130.0       1.000  0
                    </tableData>
                </table>
            </function>
        </fcs_function>

    </channel>









    <channel execrate="1" name="Leading edge flaps">

        <!-- TN D-8176 has an alternative LEF schedule, consider trying it, even though it older than TP-1538,
             simply cause TP-1538 is a simplified schedule.
             ADA189675 has the real schedule, but its unreadable, sadly. -->

        <lead_lag_filter name="fcs/fly-by-wire/lef/lead-lag">
          <input> aero/alpha-deg </input>
          <c1> 2 </c1>
          <c2> 7.25 </c2>
          <c3> 1 </c3>
          <c4> 7.25 </c4>
        </lead_lag_filter>

        <pure_gain name="fcs/fly-by-wire/lef/alpha-gain">
            <input>fcs/fly-by-wire/lef/lead-lag</input>
            <gain>1.38</gain>
        </pure_gain>

        <fcs_function name="fcs/fly-by-wire/lef/qcps-ratio-simplified">
            <description>
                GR1F-16CJ-1 Page 1-121
                DBU - LEF scheduling is simplified and optimized for a
                cruise condition at approximately 20,000 feet MSL.
            </description>
            <function>
                <quotient>
                    <p>velocities/vc-kts</p>
                    <v>975</v>
                </quotient>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/lef/qcps-ratio">
            <default value="fcs/fly-by-wire/qcps-ratio"/>
            <test value="fcs/fly-by-wire/lef/qcps-ratio-simplified">
                fcs/fly-by-wire/digital-backup == 1
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/lef/cmd-pos">
            <function>
                <min>
                    <v>25</v>
                    <max>
                        <v>0</v>
                        <sum>
                            <p>fcs/fly-by-wire/lef/alpha-gain</p>
                            <product>
                                <value>-9.05</value>
                                <p>fcs/fly-by-wire/lef/qcps-ratio</p>
                            </product>
                            <v>1.45</v>
                        </sum>
                    </max>
                </min>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/lef/cmd-pos-elec">
            <description>
                GR1F-16CJ-1 page 1-127
                When operating on standby gains, the LEF's are at
                zero degrees with the LG handle in UP and the ALT
                FLAPS switch in NORM. The LEF's deflect 15
                degrees down with the LG handle in DN or the ALT
                FLAPS switch in EXTEND.
                GR1F-16CJ-1 page 1-118
                The LEF's are automatically programmed when the LE FLAPS switch is in AUTO.
                Exceptions are:
                - When weight is on both MLG (the LEF's are 2 degrees up).
                - When the throttle is at IDLE and MLG wheel speed is greater than
                  60 knots groundspeed (the LEF's are 2 degrees up).
                - LEF asymmetry brakes are locked.
                - When the FLCS is operating on standby gains.
                In addition, from observation, the LEF's are extended to 15 degrees
                on take off, when weight is off of both MLG and LG handle is down.
                Ref: https://www.youtube.com/watch?v=_LUsto6k3qs
                Ref: https://www.airliners.net/forum/viewtopic.php?t=759285#p10957693
                GR1F-16CJ-1 page 1-120
                DBU - Standby gains are not engaged.
                GR1F-16CJ-1 page 1-121
                DBU - LEF are not commanded to 2 degrees up when MLG wheel speed is8522
                greater than 60 knots and the throttle is IDLE or if MLG WOW.
            </description>
            <default value="fcs/fly-by-wire/lef/cmd-pos"/>
            <test logic="AND" value="fcs/fly-by-wire/lef/cmd-pos-elec">
                elec/bus/flcc/d lt 20
            </test>
            <test value="fcs/fly-by-wire/lef/cmd-pos">
                fcs/fly-by-wire/digital-backup == 1
            </test>
            <test logic="AND" value="0">
                fcs/fly-by-wire/enable-standby-gains == 1
                gear/gear-cmd-norm == 0
                /controls/flight/flaps eq 0
            </test>
            <test logic="AND" value="15">
                fcs/fly-by-wire/enable-standby-gains == 1
            </test>
            <test logic="AND" value="0">  <!-- Should be -2 deg -->
                fcs/fly-by-wire/MLG-GND == 1
            </test>
            <test logic="AND" value="0">  <!-- Should be -2 deg -->
                gear/unit[1]/wheel-speed-fps gt 100
                fcs/throttle-cmd-deg lt 18
                fcs/throttle-cmd-deg ge 16
                /f16/engine/cutoff-release-lever == 0 <!-- if this is 1 then throttle is not in IDLE -->
            </test>
            <test logic="AND" value="15">
                <!-- Using wheel-speed-fps to detect start of flight, either take off or go around.
                     Should give enough time to select gear up before spin down. -->
                gear/unit[1]/wheel-speed-fps gt 0
                gear/gear-cmd-norm == 1
            </test>
        </switch>

        <lag_filter name="fcs/fly-by-wire/lef/servo">
            <input> fcs/fly-by-wire/lef/cmd-pos-elec </input>
            <c1> 7.3529 </c1><!-- 1/0.136 -->
        </lag_filter>

        <switch name="fcs/fly-by-wire/lef/pos-hyd">
          <default value="0"/>
          <test  logic="OR" value="fcs/fly-by-wire/lef/lef-pos-deg">
            /f16/fcs/le-flaps-switch == 0
          </test>
          <test  logic="OR" value="fcs/fly-by-wire/lef/servo">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <kinematic name="fcs/fly-by-wire/lef/lef-pos-deg">
            <input>fcs/fly-by-wire/lef/pos-hyd</input>
            <noscale/>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>25</position>
                    <time>1</time><!-- 25 degs per second -->
                </setting>
            </traverse>
            <clipto>
                <min>0</min>
                <max>25</max>
            </clipto>
        </kinematic>

        <pure_gain name="fcs/fly-by-wire/lef/lef-pos-rad">
            <input>fcs/fly-by-wire/lef/lef-pos-deg</input>
            <gain>0.017453</gain>
        </pure_gain>        

        <aerosurface_scale name="fcs/fly-by-wire/lef/lef-pos-norm">
            <input>fcs/fly-by-wire/lef/lef-pos-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> 0 </min>
                <max> 25 </max>
            </domain>
            <range>
                <min>0</min>                
                <max>1</max>
            </range>
        </aerosurface_scale>

        <fcs_function name="fcs/fly-by-wire/lef/lef-pos-r-norm">
            <description>Inversed normalized LEF. Used in aero.</description>
            <function>
                <difference>
                    <v>1</v>
                    <p>fcs/fly-by-wire/lef/lef-pos-norm</p>
                </difference>
            </function>
        </fcs_function>

    </channel><!-- end of LEF channel -->













    <channel name="Trailing edge flaps">

        <switch name="fcs/fly-by-wire/tef/cmd-gear">
            <default value="0"/>
            <test logic="AND" value="1">
                gear/gear-cmd-norm == 1
            </test>
        </switch>

        <switch name="fcs/fly-by-wire/tef/cmd-switch">
            <default value="fcs/fly-by-wire/tef/cmd-gear"/>
            <test logic="AND" value="1">
                /controls/flight/flaps gt 0
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/tef/cmd-deg">
            <function>
                <product>
                    <p>fcs/fly-by-wire/tef/cmd-switch</p>
                    <table>
                        <independentVar lookup="row">velocities/vc-kts</independentVar>
                        <tableData>
                            250 20
                            370  0
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/tef/cmd">
            <description>
                GR1F-16CJ-1 page 1-120
                DBU - With the LG handle in DN, the TEF's are positioned to 20 degrees down.
                With the LG handle in UP and the ALT FLAPS in EXTEND, the TEF's are
                positioned to 20 degrees down if airspeed is less than 290 knots.
            </description>
            <default value="0"/>
            <test value="fcs/fly-by-wire/tef/cmd-deg">
                fcs/fly-by-wire/digital-backup == 0
            </test>
            <test logic="OR" value="20">
                fcs/fly-by-wire/tef/cmd-gear == 1
                <test logic="AND">
                    /controls/flight/flaps == 1
                    velocities/vc-kts lt 290
                </test>
            </test>
        </switch>

        <summer name="fcs/fly-by-wire/tef/F9-limit">
            <input> fcs/fly-by-wire/tef/F9 </input>
            <clipto>
                <min> -2 </min>
                <max>  2 </max>
            </clipto>
        </summer>

        <summer name="fcs/fly-by-wire/tef/sum">
            <input> fcs/fly-by-wire/tef/cmd </input>
            <input> -fcs/fly-by-wire/tef/int </input>
            <input> fcs/fly-by-wire/tef/F9-limit </input>
            <clipto>
                <min> -0.625 </min>
                <max>  0.625 </max>
            </clipto>
        </summer>

        <integrator name="fcs/fly-by-wire/tef/int">
            <input> fcs/fly-by-wire/tef/sum </input>
            <c1> 8 </c1>
        </integrator>

        <switch name="fcs/fly-by-wire/tef/braking-help">
            <description> 
                The flaps will deploy up to help with braking,
                it will produce drag, and since they are going up,
                will also reduce lift.               
            </description>
            <default value="fcs/fly-by-wire/tef/int"/>
            <test logic="OR" value="-23">
                fcs/fly-by-wire/condition-b == 1
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/tef/int-elec">
            <description>
            </description>
            <default value="fcs/fly-by-wire/tef/braking-help"/>
            <test logic="AND" value="fcs/fly-by-wire/tef/int-elec">
                elec/bus/flcc/d lt 20
            </test>
        </switch>
        
        <switch name="fcs/fly-by-wire/tef/hyd">
          <description>
             Since this is going to be fed into Aerodynamics as flaps and HUD as info,
             we need to make sure to check for hydraulics and power here.
             Else we get what flaps is commanded to do, not what they are at.
          </description>
          <default value="0"/>
          <test  logic="OR" value="fcs/fly-by-wire/tef/int-elec">
            systems/hydraulics/sysa-psi ge 2000
            systems/hydraulics/sysb-psi ge 2000
          </test>
         </switch>

        <fcs_function name="fcs/fly-by-wire/tef/tef-pos-deg">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/tef/hyd </property>
                    <value> 1.5 </value>
                </sum>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/tef/tef-pos-norm">
            <description>
                Using integrator output as mechanical bias should not be feed into aerodynamics,
                so we bypass that here, this is the property that is fed into aerodynamics.
            </description>
            <input>fcs/fly-by-wire/tef/hyd</input>
            <gain>0.05</gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/tef/tef-pos-deg-hud">
            <description>This value should be displayed in HUD.</description>
            <input>fcs/fly-by-wire/tef/tef-pos-norm</input>
            <gain>20</gain>
        </pure_gain>

    </channel><!-- end of TEF channel -->








    <channel name="YF-16 Fly-by-wire mappings to model">

        <pure_gain name="fcs/fly-by-wire/model/rudder-pos-norm">
            <description>One to one</description>
            <input>fcs/fly-by-wire/yaw/rudder-pos-norm</input>
            <gain>1</gain>
            <output>fcs/rudder-pos-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/dht-right-pos-rad">
            <description>Degrees to radians</description>
            <input>fcs/fly-by-wire/pitch/horz-tail-right-deflection-deg</input>
            <gain>0.017453</gain>
            <output>fcs/dht-right-pos-rad</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/dht-left-pos-rad">
            <description>Degrees to -radians</description>
            <input>fcs/fly-by-wire/pitch/horz-tail-left-deflection-deg</input>
            <gain>-0.017453</gain>
            <output>fcs/dht-left-pos-rad</output>
            <output>fcs/elevator-pos-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/left-aileron-pos-norm">
            <description>Degrees to 21.5 degrees</description>
            <input>fcs/fly-by-wire/roll/flaperon-left-deflection-deg</input>
            <gain>0.0465</gain>
            <output>fcs/left-aileron-pos-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/right-aileron-pos-norm">
            <description>Degrees to 21.5 degrees.</description>
            <input>fcs/fly-by-wire/roll/flaperon-right-deflection-deg</input>
            <gain>0.0465</gain>
            <output>fcs/right-aileron-pos-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/left-flaperon-norm">
            <description>Degrees to -20 degrees</description>
            <input>fcs/fly-by-wire/roll/flaperon-left-deflection-deg</input>
            <gain>-0.05</gain>
            <output>fcs/left-flaperon-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/right-flaperon-norm">
            <description>Degrees to 20 degrees</description>
            <input>fcs/fly-by-wire/roll/flaperon-right-deflection-deg</input>
            <gain>0.05</gain>
            <output>fcs/right-flaperon-norm</output>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/model/lef-pos-deg">
            <description>One to one</description>
            <input>fcs/fly-by-wire/lef/lef-pos-deg</input>
            <gain>1</gain>
            <output>fcs/lef-pos-deg</output>
            <output>fcs/flap-pos-norm</output>
        </pure_gain>

        <!-- the below components rounds flaps position in degrees to zero decimal points: -->

        <fcs_function name="fcs/fly-by-wire/model/flap-pos-deg-with-frac">
            <function>
                <product>
                    <v>0.1</v>
                    <integer>
                        <product>
                            <v>10</v>
                            <p>fcs/fly-by-wire/tef/tef-pos-deg-hud</p>
                        </product>
                    </integer>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/model/flap-pos-deg-frac">
            <function>
                <fraction>
                      <p>fcs/fly-by-wire/model/flap-pos-deg-with-frac</p>
                </fraction>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/model/flap-pos-deg-frac-add">
            <default value="0"/>
            <test logic="AND" value="1">
                fcs/fly-by-wire/model/flap-pos-deg-frac ge 0.5
            </test>
            <test logic="AND" value="-1">
                fcs/fly-by-wire/model/flap-pos-deg-frac le -0.5
            </test>
        </switch>

        <fcs_function name="fcs/fly-by-wire/model/flap-pos-deg-final">
            <function>
                <sum>
                    <integer>
                        <p>fcs/fly-by-wire/tef/tef-pos-deg-hud</p>
                    </integer>
                    <p>fcs/fly-by-wire/model/flap-pos-deg-frac-add</p>
                </sum>
            </function>
            <output>fcs/flap-pos-deg</output>
        </fcs_function>

    </channel><!-- end of FBW anim channel -->
    
    
    
<!-- end: FBW control system by Nikolai V. Chr. -->

















































  <channel name="Landing Gear">

   <switch name="fcs/gear-wow">
    <default value="0"/>
    <test logic="AND" value="1">
     gear/unit[1]/WOW eq 1
     gear/unit[2]/WOW eq 1
    </test>
   </switch>

   <switch name="fcs/gear-wow-cmd-norm">
        <!-- prevent gear up command while wheels on ground. Block 50 manual page 1-70 -->
      <default value="gear/gear-cmd-norm"/>
      <test  logic="OR" value="1">
        fcs/gear-wow == 1
      </test>
   </switch>

   <switch name="fcs/gear-hyd">
      <default value="fcs/gear-control"/>
      <test  logic="OR" value="fcs/gear-wow-cmd-norm">
        systems/hydraulics/sysb-psi ge 2000
      </test>
      <test  logic="AND" value="1">
        /f16/cockpit/alt-gear-handle == 1
        /f16/cockpit/alt-gear-pneu == 1
      </test>
   </switch>
   
   <switch name="systems/cockpit/alt-gear-pneu">
      <default value="/f16/cockpit/alt-gear-pneu"/>
      <test  logic="AND" value="0">
        /f16/cockpit/alt-gear-handle == 1
        fcs/gear-control == 1
      </test>
      <output>/f16/cockpit/alt-gear-pneu</output>
   </switch>
         
   <kinematic name="fcs/gear-control">
    <input>fcs/gear-hyd</input>
    <traverse>
     <setting>
      <position>0</position>
      <time>0</time>
     </setting>
     <setting>
      <position>1</position>
      <time>5</time>
     </setting>
    </traverse>
    <output>gear/gear-pos-norm</output>
   </kinematic>

   <scheduled_gain name="fcs/scheduled-steer-pos-deg">
    <input>fcs/steer-cmd-norm</input>
    <table>
     <independentVar lookup="row">velocities/vg-fps</independentVar>
     <independentVar lookup="column">elec/bus/emergency-dc-1</independentVar>
     <independentVar lookup="table">/controls/gear/nose-wheel-steering</independentVar>
     <tableData breakPoint="0">
            0 20
       1.0  0  0
       2.0  0  0
     </tableData>
     <tableData breakPoint="1">
            0 20
       1.0  0  10.0
      10.0  0  32.0
      20.0  0  15.0
      50.0  0   4.5
      100.0 0   2.0
      150.0 0   1.0
      300.0 0   0.5
     </tableData>
    </table>
    <output>fcs/steer-pos-deg</output>
   </scheduled_gain>

  </channel>
   


  <channel name="Speedbrake">
   <!--
     - To prevent deep stall the Flight Computer commands speedbrake
     - deflection at high angle of attack (alpha) and low speeds. This
     - will provide just enough pitch down moment to keep the aircraft
     - under control.
     -->
   <switch name="fcs/speedbrake-alpha-limiter">
    <default value="0"/>
    <test logic="AND" value="1">
     aero/alpha-deg ge 53 
     velocities/v-fps le 18
     fcs/fly-by-wire/MLG-GND == 0
    </test>
   </switch>

   <switch name="fcs/speedbrake-initiate">
    <default value="0"/>
    <test logic="OR" value="1">
     fcs/speedbrake-alpha-limiter eq 1
     fcs/speedbrake-cmd-norm eq 1
    </test>
   </switch>

   <!--
     - Speedbrake deflection is limited to 43 degrees (instead of 60
     - degrees) when the gear is extended to prevent physical
     - speedbrake damage on touchdown.
     -->
   <scheduled_gain name="fcs/speedbrake-scheduler">
    <input>fcs/speedbrake-initiate</input>
    <table>
     <independentVar lookup="row">gear/gear-pos-norm</independentVar>
     <independentVar lookup="column">gear/unit[0]/WOW</independentVar>
     <tableData>
         0        1
      0 1.0       1.0
      1 0.71667   1.0
     </tableData>
    </table>
    <!-- <output>fcs/speedbrake-pos-norm</output> -->
   </scheduled_gain>

   <switch name="fcs/speedbrake-hyd">
     <default value="0"/>
     <test  logic="AND" value="fcs/speedbrake-scheduler">
       systems/hydraulics/sysa-psi ge 2000
       elec/bus/emergency-dc-1 gt 20
     </test>
    </switch>

   <kinematic name="fcs/speedbrake-control">
    <input>fcs/speedbrake-hyd</input>
    <traverse>
     <setting>
      <position>0</position>
      <time>0</time>
     </setting>
     <setting>
      <position>60</position>
      <time>2</time>                                      <!-- 2 seconds to deploy -->
     </setting>
    </traverse>
    <output>fcs/speedbrake-pos-deg</output>
   </kinematic>

     <aerosurface_scale name="fcs/speedbrake-position-normalizer">
     <input>fcs/speedbrake-control</input>
     <domain>
        <min>0</min>
        <max>60</max>
     </domain>
     <range>
        <min>0</min>
        <max>1</max>
     </range>
     <output>fcs/speedbrake-pos-norm</output>
   </aerosurface_scale>

  </channel>

  <channel name="Canopy">

   <switch name="fcs/canopy-trigger">
    <default value="fcs/canopy-engage"/>
    <test value="1">
     /canopy/not-serviceable == 1
    </test>
    <test logic="AND" value="fcs/canopy-trigger">
        elec/bus/emergency-dc-2 lt 20
        elec/switches/main-pwr gt 0
    </test>
    <test logic="AND" value="fcs/canopy-trigger">
        elec/sources/battery-volt lt 20
        elec/switches/main-pwr == 0
    </test>
    <test value="0">
     velocities/u-fps gt 1.0
    </test>
   </switch>

   <kinematic name="fcs/canopy-control-1">
    <input>fcs/canopy-trigger</input>
    <traverse>
     <setting>
      <position>0</position>
      <time>0</time>
     </setting>
     <setting>
      <position>1</position>
      <time>10</time>
     </setting>
    </traverse>
   </kinematic>
   
   <switch name="fcs/canopy-control">
    <default value="fcs/canopy-control-1"/>
    <test value="1">
     /canopy/not-serviceable == 1
    </test>
    <output>fcs/canopy-pos-norm</output>
    <output>/canopy/position-norm</output>
   </switch>

  </channel>
  
  <!--<channel name="Gun">
    <switch name="fcs/guntrigger">
    <default value="0"/>
    <test logic="AND" value="1">
         /controls/armament/trigger eq 1
         systems/hydraulics/sysb-psi ge 2000
    </test>
    </switch>
  </channel>-->



 </flight_control>
