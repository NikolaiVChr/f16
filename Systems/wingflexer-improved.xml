<?xml version="1.0" encoding="UTF-8"?>
<PropertyList>
    <debug>true</debug>

    <!-- Some filters are useful when tuning the parameters, but not needed in
         production aircraft. They're tagged DEVELOP and disabled by default. -->

    <!-- limit time step -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/delta-sec</output>
        <input>
            <property>/sim/time/delta-sec</property>
        </input>
        <max>0.05</max>
    </filter>

    <!-- compute k and d -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/k</output>
        <input>
            <expression>
                <product>
                    <property>/sim/systems/wingflexer/params/fuel-frac</property>
                    <property>/sim/systems/wingflexer/params/K</property>
                    <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                </product>
            </expression>
        </input>
    </filter>

    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/d</output>
        <input>
            <expression>
                <product>
                    <property>/sim/systems/wingflexer/params/fuel-frac</property>
                    <property>/sim/systems/wingflexer/params/D</property>
                    <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                </product>
            </expression>
        </input>
    </filter>

    <!-- normal force. Convert to Newton and use 1/2 (one wing only) -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/f-normal-N</output>
        <input>
            <expression>
                <product>
                    <property>/sim/systems/wingflexer/params/fuel-frac</property>
                    <property>/sim/systems/wingflexer/params/normal-node-lbs</property>
                    <value>0.226796</value> <!-- LB2KG / 2-->
                </product>
            </expression>
        </input>
    </filter>
    

    <!-- z_ofs = g * mass_dry_kg / k -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/z-ofs-m</output>
        <input>
            <expression>
                <div>
                    <product>
                        <property>/sim/systems/wingflexer/params/fuel-frac</property>
                        <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                    </product>
                    <property>/sim/systems/wingflexer/k</property>
                </div>
            </expression>
        </input>
    </filter>

    <!--
    compute total mass of one wing, using the average fuel mass in all wing tanks.
    The weighting factor should be lumped into fuel_frac.
      mass = mass_dry_kg + fuel_frac * sum_i (fuel_node_i_kg)
    -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/m-wing-kg</output>
        <input>
            <expression>
                    <product>
                        <property>/sim/systems/wingflexer/params/fuel-frac</property>
                        <sum>
                            <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                            <product>
                                <value>0.5</value><!-- half since we only want 1 wing -->
                                <sum>
                                    <property>/sim/systems/wingflexer/params/fuel-node-1-kg</property>
                                    <property>/sim/systems/wingflexer/params/fuel-node-2-kg</property>
                                    <property>/sim/systems/wingflexer/params/fuel-node-3-kg</property>
                                    <property>/sim/systems/wingflexer/params/fuel-node-4-kg</property>
                                </sum>
                            </product>
                        </sum>
                    </product>
            </expression>
        </input>
    </filter>
    
    <!--  -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/half-fuselage-weight</output>
        <input>
            <expression>
                <product>
                    <property>/sim/systems/wingflexer/params/fuel-frac</property>
                    <value>0.5</value><!-- half the body, as the 2 wings share the load -->
                    <property>/sim/systems/wingflexer/params/aircraft-g-force</property><!-- body mass is multiplied by G -->
                    <difference>
                        <product>
                            <property>/sim/systems/wingflexer/params/aircraft-total-weight-lbs</property>
                            <value>0.4535</value><!-- lbs to kg -->
                        </product>
                        <sum><!-- subtract both wings mass -->
                            <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                            <property>/sim/systems/wingflexer/params/m-wing-dry-kg</property>
                            <sum>
                                <property>/sim/systems/wingflexer/params/fuel-node-1-kg</property>
                                <property>/sim/systems/wingflexer/params/fuel-node-2-kg</property>
                                <property>/sim/systems/wingflexer/params/fuel-node-3-kg</property>
                                <property>/sim/systems/wingflexer/params/fuel-node-4-kg</property>
                            </sum>
                        </sum>
                    </difference>
                </product>
            </expression>
        </input>
    </filter>
    
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/c-input</output>
        <input>
            <expression>
                <product>
                    <value>-1</value>
                    <sum>
                        <!-- in air -->
                        <product>
                            <property>/sim/systems/wingflexer/half-fuselage-weight</property>
                            <property>/sim/systems/wingflexer/params/body-factor</property>
                            <abs>
                                <difference>
                                    <property>/sim/systems/wingflexer/params/aerotow-active</property>
                                    <value>1</value>
                                </difference>
                            </abs>
                            <abs>
                                <difference>
                                    <property>fdm/jsbsim/gear/unit[1]/WOW</property>
                                    <value>1</value>
                                </difference>
                            </abs>
                        </product>
                        <!-- on ground -->
                        <product>
                            <property>fdm/jsbsim/gear/unit[1]/WOW</property>
                            <difference>
                                <property>/sim/systems/wingflexer/f-normal-N</property>
                                <product>
                                    <property>/sim/systems/wingflexer/params/aircraft-g-force</property><!-- at landings G can affect how much wing weighs -->
                                    <property>/sim/systems/wingflexer/m-wing-kg</property>
                                </product>
                            </difference>
                        </product>
                        <!-- towed -->
                        <product>
                            <difference>
                                <property>/sim/systems/wingflexer/f-normal-N</property>
                                <product>
                                    <property>/sim/systems/wingflexer/params/aircraft-g-force</property>
                                    <property>/sim/systems/wingflexer/m-wing-kg</property>
                                </product>
                            </difference>
                            <property>/sim/systems/wingflexer/params/aerotow-active</property>
                            <abs>
                                <difference>
                                    <property>fdm/jsbsim/gear/unit[1]/WOW</property>
                                    <value>1</value>
                                </difference>
                            </abs>
                        </product>
                    </sum>
                </product>
            </expression>
        </input>
    </filter>

    <!-- integrate the ODE -->
    <filter>
        <type>damped-oscillation</type>
	    <output>/sim/systems/wingflexer/z-raw-m</output>
        <min><property>/sim/systems/wingflexer/params/min</property></min>
        <max><property>/sim/systems/wingflexer/params/max</property></max>
        <a>
    	    <expression>
                <div>
        		      <property>/sim/systems/wingflexer/d</property>
        		      <property>/sim/systems/wingflexer/m-wing-kg</property>
                </div>
            </expression>
    	</a>
        <b>
    	    <expression>
                <div>
        		      <property>/sim/systems/wingflexer/k</property>
        		      <property>/sim/systems/wingflexer/m-wing-kg</property>
                </div>
            </expression>
    	</b>
        <c>
    	    <expression>
                <sum>
                    <max>
                        <value>0</value>
                        <property>/sim/systems/wingflexer/c-input</property>
                    </max>
                    <min>
                        <value>0</value>
                        <product>
                            <property>/sim/systems/wingflexer/params/upwards-stiffness-factor</property>
                            <property>/sim/systems/wingflexer/c-input</property>
                        </product>
                    </min>
                </sum>
            </expression>
    	</c>
        <!-- DEVELOP: initialize the wing's vertical velocity to a given value,
                      overriding all previous computations -->
	    <input>
            <expression>
                <product>
                    <property>/sim/systems/wingflexer/sink-rate-fps</property>
                    <value>0.3048</value> <!-- feet to meters -->
                </product>
            </expression>
        </input>
    </filter>

    <filter>
        <type>gain</type>
        <output>/sim/systems/wingflexer/z-m</output>
        <!--<min><property>/sim/systems/wingflexer/params/min</property></min>
        <max><property>/sim/systems/wingflexer/params/max</property></max>-->
        <!--<gain>1.</gain> -->
        <!-- DEVELOP: scaled output. For production aircraft, this should be done in
                    the model animation. -->
        <gain><property>/sim/systems/wingflexer/params/z-fac</property></gain>
        
	<input>
            <expression>
                <sum>
                    <property>/sim/systems/wingflexer/z-raw-m</property>
                    <property>/sim/systems/wingflexer/z-ofs-m</property>
                </sum>
            </expression>
        </input>
    </filter>

    <!-- DEVELOP: reset sink rate -->
    <filter>
        <type>gain</type>
        <gain>0.</gain>
        <output>/sim/systems/wingflexer/sink-rate-fps</output>
    </filter>
    
    <!-- DEVELOP: log max z-m -->
    <filter>
        <type>gain</type>
        <gain>1.</gain>
        <output>/sim/systems/wingflexer/z-max-m</output>
        <input>
            <expression>
                <max>
                    <property>/sim/systems/wingflexer/z-max-m</property>
                    <abs>
                        <property>/sim/systems/wingflexer/z-m</property>
                    </abs>
                </max>
            </expression>
        </input>
    </filter>

</PropertyList>
